{% extends 'templates/base.html' %}
{% load static %}

{% block head %}
<title>{{ title }}</title>
{% endblock %}

{% block content %}
    <div class="container ui">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-12 col-md-10 col-lg-7 col-xl-5">
                <h1 class="mb-3">Buat Panduan</h1>
   
                <div class="ui icon message warning mb-4">
                    <i class="exclamation triangle icon"></i>
                    <div class="content">
                        <p>Pastikan <strong>penamaan</strong> dan pilihan <strong>kategori</strong> sudah benar.
                        Apapun tindakan setelah proses ini merupakan "Revisi" layaknya sistem
                        <i>Repository Git</i>.</p>
                    </div>
                </div>

                <form class="ui form mb-4 pb-4">
                    <div class="field">
                        <label>Nama Panduan</label>

                        <div class="ui left icon input">
                            <i class="book icon"></i>
                            <input name="label" type="text" required>
                        </div>
                    </div>

                    <div class="grouped fields">
                        <label>Kategori</label>

                        <div class="row m-0">
                            {% for item in categories %}
                                <div class="field col-12 col-sm-6">
                                    <div class="ui radio checkbox">
                                        <input type="radio" name="category" value="{{ item.pk }}" required>
                                        <label>{{ item.label }}</label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="field">
                        <label>Keterangan</label>

                        <div class="ui input">
                            <textarea name="description" required></textarea>
                        </div>
                    </div>

                    <div class="ui error message"></div>

                    <div class="ui primary button submit mr-auto">
                        <i class="check icon"></i>
                        Submit
                    </div>
                </form>
            </div>
        </div>
    </div> <!-- /.container -->
{% endblock %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static 'vendors/semantic/components/form.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'vendors/semantic/components/input.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'vendors/semantic/components/label.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'vendors/semantic/components/loader.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'vendors/semantic/components/checkbox.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'vendors/semantic/components/message.min.css' %}">
{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'vendors/semantic/components/checkbox.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/semantic/components/form.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendors/sweetalert2/dist/sweetalert2.all.min.js' %}"></script>
    
    <script type="text/javascript">
        $('.checkbox').checkbox();

        // ...
        // SUBMIT HANDLER
        // ...
        function submitHandler($element=null, $fields) {
            $.ajax({
                method: 'POST',
                url: '/api/beacon/guides/',
                headers: {'X-CSRFToken': Cookies.get('csrftoken')},
                xhrFields: {withCredentials: true},
                data: {
                    ...$fields,
                    csrfmiddlewaretoken: Cookies.get('csrftoken'),
                },
                success: function(response) {
                    window.location.replace(response.url);
                },
                error: function(error) {
                    $($element).removeClass('loading');

                    if (error && error.responseJSON) {
                        var errorJSON = error.responseJSON,
                            errorMessage = [];

                        $.each(errorJSON, function(index, item) {
                            var label = '<span class="text-capitalize font-weight-bold text-danger">' + index + '</span>: ';
                            
                            if (Array.isArray(item)) {
                                errorMessage.push(label + item.join(' '));
                            } else {
                                errorMessage.push(label + item);
                            }
                        });

                        if (errorMessage.length == 0) errorMessage.push('Terjadi kesalahan. Coba lagi.');

                        // Show error
                        if (errorMessage) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                html: '<div class="text-center">' + errorMessage.join('<br /><br />') + '</div>',
                            });
                        }
                    }
                }
            });
        }

        // ...
        // FORM VALIDATION
        // ...
        $('.form').form({
            on: 'blur',
            fields: {
                label: {
                    identifier: 'label',
                    rules: [
                        {
                            type   : 'empty',
                            prompt : 'Nama panduan tidak boleh kosong'
                        },
                        {
                            type   : 'minLength[4]',
                            prompt : 'Nama panduan minimal 4 karakter'
                        }
                    ]
                },
                category: {
                    identifier: 'category',
                    rules: [
                        {
                            type   : 'checked',
                            prompt : 'Pilih salah satu Kategori'
                        }
                    ]
                },
                description: {
                    identifier: 'description',
                    rules: [
                        {
                            type   : 'empty',
                            prompt : 'Keterangan tidak boleh kosong'
                        },
                        {
                            type   : 'minLength[25]',
                            prompt : 'Keterangan minimal 25 karakter'
                        }
                    ]
                },
            },
            onSuccess: function(event, fields) {
                // Prevent default form submit!
                // We use REST API for handle login.
                if (event) {
                    event.preventDefault();

                    $(event.target).addClass('loading');
                    submitHandler(event.target, fields);
                }
            }
        });

        $(document).on('change', '[name="category"]', function(event) {
            $('.form').form('validate form');
        });

        $(document).on('keyup', '[name="label"], [name="description"]', function(event) {
            $('.form').form('validate form');
        });
    </script>
{% endblock %}
