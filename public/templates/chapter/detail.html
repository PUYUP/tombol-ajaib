{% extends 'templates/base.html' %}
{% load static %}
{% load sidenav %}

{% block head %}
<title>{{ title }}</title>
{% endblock %}

{% block content %}
    <div class="container main-content d-flex pt-0">
        <div class="docs-nav pr-4 align-self-stretch position-relative">
            <div class="tools d-flex w-100 align-items-center">
                {% if guide_obj.creator.id == person_pk %}
                    <button type="button" class="btn btn-info btn-block pl-4 pr-4" data-toggle="modal" data-target="#modalAddChapter">
                        Tambah Bab
                    </button>
                {% else %}
                    <button type="button" class="btn btn-info btn-block pl-4 pr-4" data-toggle="modal" data-target="#modalAddChapter">
                        Tampilkan Semua
                    </button>
                {% endif %}
            </div>

            <div class="chapter-wrap h-100">
                <div class="chapter-list pr-3 pb-3 pt-2"></div>
            </div>
        </div> <!-- /.docs-nav -->

        <div class="docs-content flex-grow-1">
            <div class="pt-2">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab"
                            aria-controls="home" aria-selected="true">Konsep</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                            aria-controls="profile" aria-selected="false">Terbit</a>
                    </li>
                </ul>

                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">...</div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">...</div>
                </div>

                <h1>{{ chapter_obj.label }}</h1>

                {% if chapter_obj.description %}
                    <p>{{ chapter_obj.description }}</p>
                {% endif %}

                # published: {{ chapter_obj.published_version }}
                # draft: {{ chapter_obj.draft_version }}

                
                <ul>
                {% for key, value in res.items %}
                    <li>
                        {{ key.sort_stage }} {{ key.label }} - {{ key.chapter_draft_version }} - {{ key.chapter_published_version }}
                        
                        <ul>
                            {% for item in value %}
                                <li>{{ item.label }} - {{ item.explain_draft_version }} - {{ item.explain_published_version }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                {% endfor %}
                </ul>
                
                {% comment %}
                <ul>
                    {% for item in unit_list %}
                        <li>{{ item.chapter.label }}</li>

                        <ul>
                            {% for eitem in item.explains %}
                                <li>{{ eitem.label }} - {{ eitem.explain_draft_version }} - {{ eitem.explain_published_version }}</li>
                            {% endfor %}
                        </ul>
                    {% endfor %}
                </ul>
                {% endcomment %}
            </div>
        </div> <!-- /.docs-content -->
    </div> <!-- /.main content -->
{% endblock %}

{% block js %}
    <script type="text/javascript" src="{% static 'vendors/jquery-sticky/jquery.sticky-sidebar.min.js' %}"></script>

    <script type="text/javascript">
        var chapterObjs = $.ajax('/api/beacon/chapters/?guide_uuid={{ chapter_obj.guide.uuid }}');
        var explainObjs = $.ajax('/api/beacon/explains/?guide_uuid={{ chapter_obj.guide.uuid }}');

        $.when(chapterObjs, explainObjs).done(function(chapterRes, explainRes) {
            var combineChapterExplain = [],
                chapterItem = '',
                chapters = chapterRes[0],
                explains = explainRes[0];
    
            $.each(chapters, function(index, value) {
                var explainFiltered = explains.filter(function(x) {
                    return x.chapter_uuid === value.uuid;
                });

                value.explains = explainFiltered;
                combineChapterExplain.push(value);
            });

            $.each(combineChapterExplain, function(index, value) {
                var explainsList = '',
                    explainItem = '',
                    explains = value.explains,
                    uuid = value.published ? value.published.uuid : value.draft.uuid,
                    has_explain = explains.length > 0;
                
                if (has_explain) {
                    $.each(explains, function(ei, ev) {
                        var rev_uuid = ev.published ? ev.published.uuid : ev.draft.uuid;

                        explainItem += `<li id="item_${ev.id}" data-uuid="${rev_uuid}">
                            <a href="${ev.permalink}" class="text-dark">
                                ${ev.published ? ev.published.label : ev.draft.label}
                                [${ev.published ? ev.published.status : ev.draft.status}]
                            </a>
                        </li>`;
                    });

                    explainsList = `<ul class="list-unstyled pl-3 pt-1 explain-list">${explainItem}</ul>`;
                }

                chapterItem += `<div id="item_${value.id}" class="chapter-group" data-uuid="${uuid}">
                    <h3 class="header">
                        <a href="${value.permalink}" class="text-dark">
                            ${value.published ? value.published.label : value.draft.label}
                            [${value.published ? value.published.status : value.draft.status}]
                        </a>
                    </h3>

                    ${explainsList}
                </div>`;
            });

            if (chapterItem) $('.chapter-list').html(chapterItem);

            $('.chapter-wrap').animate({
                scrollTop: $('[data-uuid="{{ chapter_uuid }}"]').offset().top - 150
            }, 0);

            $('.chapter-wrapx').stickySidebar({
                topSpacing: 60,
                bottomSpacing: 60,
                containerSelector: '.docs-nav',
                innerWrapperSelector: '.chapter-list',
            });
        });
    </script>
{% endblock %}
